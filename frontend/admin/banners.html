<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản Lý Banner - Spa Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>

<body>
    <!-- Header -->
    <div id="header"></div>

    <!-- Main Content -->
    <main class="container">
        <!-- Page Header -->
        <div class="row between" style="margin-bottom: 20px;">
            <h1 class="page-title">Quản Lý Banner</h1>
            <button class="btn primary" onclick="openBannerModal()">
                <i class="fas fa-plus"></i> Thêm Banner
            </button>
        </div>

        <!-- Search & Filter -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="row">
                <input type="text" id="search-input" placeholder="Tìm kiếm banner..." 
                    style="flex: 1; margin: 0;" onkeyup="handleSearch()" />
                <select id="position-filter" onchange="handleSearch()" 
                    style="width: 200px; margin: 0 0 0 10px;">
                    <option value="">Tất cả vị trí</option>
                    <option value="hero">Hero</option>
                    <option value="sidebar">Sidebar</option>
                    <option value="footer">Footer</option>
                    <option value="popup">Popup</option>
                </select>
            </div>
        </div>

        <!-- Banners Table -->
        <div class="card">
            <table class="table" id="banners-table">
                <thead>
                    <tr>
                        <th style="width: 100px;">Hình Ảnh</th>
                        <th>Tiêu Đề</th>
                        <th style="width: 120px;">Vị Trí</th>
                        <th style="width: 100px;">Thứ Tự</th>
                        <th style="width: 100px;">Trạng Thái</th>
                        <th style="width: 200px;">Hành Động</th>
                    </tr>
                </thead>
                <tbody id="banners-tbody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                            <p style="margin-top: 10px;">Đang tải dữ liệu...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Modal Thêm/Sửa Banner -->
    <div class="modal hidden" id="banner-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="row between">
                <h2 id="modal-title">Thêm Banner Mới</h2>
                <button class="btn" onclick="closeBannerModal()" style="width: auto;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="banner-form" onsubmit="handleSubmit(event)">
                <input type="hidden" id="banner-id" />

                <div>
                    <label>Tiêu Đề <span style="color: red;">*</span></label>
                    <input type="text" id="banner-title" required />
                </div>

                <div style="margin-top: 16px;">
                    <label>Phụ Đề</label>
                    <input type="text" id="banner-subtitle" />
                </div>

                <div style="margin-top: 16px;">
                    <label>Mô Tả</label>
                    <textarea id="banner-description" rows="2"></textarea>
                </div>

                <div class="form-row" style="margin-top: 16px;">
                    <div>
                        <label>Vị Trí <span style="color: red;">*</span></label>
                        <select id="banner-position" required>
                            <option value="hero">Hero</option>
                            <option value="sidebar">Sidebar</option>
                            <option value="footer">Footer</option>
                            <option value="popup">Popup</option>
                        </select>
                    </div>
                    <div>
                        <label>Thứ Tự</label>
                        <input type="number" id="banner-sort" value="0" min="0" />
                    </div>
                </div>

                <div class="form-row" style="margin-top: 16px;">
                    <div>
                        <label>Ngày Bắt Đầu</label>
                        <input type="date" id="banner-start" />
                    </div>
                    <div>
                        <label>Ngày Kết Thúc</label>
                        <input type="date" id="banner-end" />
                    </div>
                </div>

                <div style="margin-top: 16px;">
                    <label>Link URL</label>
                    <input type="text" id="banner-link" placeholder="https://..." />
                </div>

                <div style="margin-top: 16px;">
                    <label>Hình Ảnh <span style="color: red;">*</span></label>
                    <input type="file" id="banner-image" accept="image/*" 
                        style="padding: 8px;" />
                    <small style="color: var(--color-gray-500);">Khuyến nghị: 1920x600px cho Hero banner</small>
                </div>

                <div style="margin-top: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="banner-active" style="width: auto;" checked />
                        Kích hoạt banner
                    </label>
                </div>

                <div class="row right" style="margin-top: 20px;">
                    <button type="button" class="btn muted" onclick="closeBannerModal()" 
                        style="width: auto;">
                        Hủy
                    </button>
                    <button type="submit" class="btn primary" style="width: auto;">
                        <i class="fas fa-save"></i> Lưu
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer"></div>

    <!-- Scripts -->
    <script>
        const API_BASE = 'http://localhost:3000/api';
        let allBanners = [];
        let editingBannerId = null;

        // Khởi tạo
        document.addEventListener('DOMContentLoaded', function () {
            loadHeader();
            loadBanners();
        });

        // Load header
        function loadHeader() {
            fetch('layouts/header.html')
                .then(r => r.text())
                .then(html => {
                    document.getElementById('header').innerHTML = html;
                });
        }

        // Load danh sách banner
        async function loadBanners() {
            try {
                const response = await fetch(`${API_BASE}/banners?limit=100`);
                const data = await response.json();
                allBanners = data?.banners || data || [];
                renderBanners(allBanners);
            } catch (error) {
                console.error('Lỗi khi tải banner:', error);
                document.getElementById('banners-tbody').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: red;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p style="margin-top: 10px;">Không thể tải dữ liệu. Vui lòng kiểm tra kết nối API.</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Render bảng banner
        function renderBanners(banners) {
            const tbody = document.getElementById('banners-tbody');

            if (banners.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            <i class="fas fa-image" style="font-size: 48px; color: #ccc;"></i>
                            <p style="margin-top: 10px; color: #999;">Chưa có banner nào</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = banners.map(banner => {
                const imageUrl = banner.image?.gridfsId 
                    ? `${API_BASE}/files/${banner.image.gridfsId}`
                    : '';
                const statusBadge = banner.isActive 
                    ? '<span style="background: var(--color-success); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem;">Kích hoạt</span>'
                    : '<span style="background: var(--color-gray-400); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem;">Tắt</span>';

                return `
                    <tr>
                        <td>
                            <img src="${imageUrl}" alt="${banner.title}" 
                                style="width: 80px; height: 50px; object-fit: cover; border-radius: 8px;"/>
                        </td>
                        <td>
                            <strong>${banner.title}</strong>
                            ${banner.subtitle ? `<p style="font-size: 0.85rem; color: #666; margin-top: 4px;">${banner.subtitle}</p>` : ''}
                        </td>
                        <td>${translatePosition(banner.position)}</td>
                        <td>${banner.sortOrder || 0}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn" onclick="editBanner('${banner._id}')" 
                                style="width: auto; margin-bottom: 6px;">
                                <i class="fas fa-edit"></i> Sửa
                            </button>
                            <button class="btn danger" onclick="deleteBanner('${banner._id}')" 
                                style="width: auto;">
                                <i class="fas fa-trash"></i> Xóa
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Dịch vị trí
        function translatePosition(position) {
            const map = {
                'hero': 'Hero',
                'sidebar': 'Sidebar',
                'footer': 'Footer',
                'popup': 'Popup'
            };
            return map[position] || position;
        }

        // Tìm kiếm và lọc
        function handleSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const positionFilter = document.getElementById('position-filter').value;

            const filtered = allBanners.filter(banner => {
                const matchesSearch = banner.title.toLowerCase().includes(searchTerm) ||
                    (banner.subtitle && banner.subtitle.toLowerCase().includes(searchTerm));
                const matchesPosition = !positionFilter || banner.position === positionFilter;

                return matchesSearch && matchesPosition;
            });

            renderBanners(filtered);
        }

        // Mở modal thêm banner
        function openBannerModal(bannerId = null) {
            editingBannerId = bannerId;
            const modal = document.getElementById('banner-modal');
            const form = document.getElementById('banner-form');
            
            form.reset();
            document.getElementById('banner-id').value = '';
            document.getElementById('banner-active').checked = true;

            if (bannerId) {
                document.getElementById('modal-title').textContent = 'Chỉnh Sửa Banner';
                loadBannerData(bannerId);
            } else {
                document.getElementById('modal-title').textContent = 'Thêm Banner Mới';
            }

            modal.classList.remove('hidden');
        }

        // Load dữ liệu banner để edit
        async function loadBannerData(bannerId) {
            const banner = allBanners.find(b => b._id === bannerId);
            if (!banner) return;

            document.getElementById('banner-id').value = banner._id;
            document.getElementById('banner-title').value = banner.title;
            document.getElementById('banner-subtitle').value = banner.subtitle || '';
            document.getElementById('banner-description').value = banner.description || '';
            document.getElementById('banner-position').value = banner.position;
            document.getElementById('banner-sort').value = banner.sortOrder || 0;
            document.getElementById('banner-link').value = banner.link?.url || '';
            document.getElementById('banner-active').checked = banner.isActive;
            
            if (banner.startDate) {
                document.getElementById('banner-start').value = new Date(banner.startDate).toISOString().split('T')[0];
            }
            if (banner.endDate) {
                document.getElementById('banner-end').value = new Date(banner.endDate).toISOString().split('T')[0];
            }
        }

        // Đóng modal
        function closeBannerModal() {
            document.getElementById('banner-modal').classList.add('hidden');
            editingBannerId = null;
        }

        // Xử lý submit form
        async function handleSubmit(event) {
            event.preventDefault();

            const bannerId = document.getElementById('banner-id').value;
            const formData = new FormData();

            // Thu thập dữ liệu
            formData.append('title', document.getElementById('banner-title').value);
            formData.append('subtitle', document.getElementById('banner-subtitle').value);
            formData.append('description', document.getElementById('banner-description').value);
            formData.append('position', document.getElementById('banner-position').value);
            formData.append('sortOrder', document.getElementById('banner-sort').value);
            formData.append('isActive', document.getElementById('banner-active').checked);
            
            const linkUrl = document.getElementById('banner-link').value;
            if (linkUrl) {
                formData.append('link', JSON.stringify({ url: linkUrl, type: 'external' }));
            }

            const startDate = document.getElementById('banner-start').value;
            const endDate = document.getElementById('banner-end').value;
            if (startDate) formData.append('startDate', startDate);
            if (endDate) formData.append('endDate', endDate);

            // Thêm hình ảnh
            const fileInput = document.getElementById('banner-image');
            if (fileInput.files.length > 0) {
                formData.append('image', fileInput.files[0]);
            } else if (!bannerId) {
                alert('Vui lòng chọn hình ảnh cho banner');
                return;
            }

            try {
                const url = bannerId ? `${API_BASE}/banners/${bannerId}` : `${API_BASE}/banners`;
                const method = bannerId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Không thể lưu banner');
                }

                alert(bannerId ? 'Cập nhật banner thành công!' : 'Thêm banner thành công!');
                closeBannerModal();
                loadBanners();

            } catch (error) {
                console.error('Lỗi khi lưu banner:', error);
                alert('Có lỗi xảy ra. Vui lòng thử lại.');
            }
        }

        // Sửa banner
        function editBanner(bannerId) {
            openBannerModal(bannerId);
        }

        // Xóa banner
        async function deleteBanner(bannerId) {
            if (!confirm('Bạn có chắc chắn muốn xóa banner này?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/banners/${bannerId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Không thể xóa banner');
                }

                alert('Xóa banner thành công!');
                loadBanners();

            } catch (error) {
                console.error('Lỗi khi xóa banner:', error);
                alert('Có lỗi xảy ra. Vui lòng thử lại.');
            }
        }
    </script>
</body>

</html>
